<!DOCTYPE html>
<html>
<head>
  <title>Study Timer</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 2em;
    }
    #timer {
      font-size: 3em;
      margin: 1em 0;
    }
    button, input {
      font-size: 1em;
      margin: 0.5em;
      padding: 0.4em 1em;
    }
    #history {
      margin-top: 2em;
      text-align: left;
      max-width: 400px;
      margin: 2em auto;
    }
    .auth-box {
      border: 1px solid #ccc;
      padding: 1em;
      max-width: 300px;
      margin: 1em auto;
      border-radius: 8px;
    }
    #user-info {
      margin-bottom: 1em;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>‚è≥ Study Timer</h1>

  <!-- Login Section -->
  <div id="login" class="auth-box">
    <h2>Login</h2>
    <input id="email" type="email" placeholder="Email"><br>
    <input id="password" type="password" placeholder="Password"><br>
    <button onclick="login()">Login</button>
    <p>Don‚Äôt have an account? <button onclick="showRegister()">Register</button></p>
  </div>

  <!-- Registration Section -->
  <div id="register" class="auth-box" style="display:none;">
    <h2>Register</h2>
    <input id="reg-email" type="email" placeholder="Email"><br>
    <input id="reg-password" type="password" placeholder="Password"><br>
    <button onclick="register()">Sign Up</button>
    <p>Already registered? <button onclick="showLogin()">Back to Login</button></p>
  </div>

  <!-- Timer App Section -->
  <div id="app" style="display:none;">
    <div id="user-info">Welcome, <span id="user-email"></span> üëã <button onclick="logout()">Logout</button></div>
    <div id="timer">00:00:00</div>
    <button onclick="startTimer()">Start</button>
    <button onclick="stopTimer()">Stop & Save</button>
    <button onclick="resetTimer()">Reset</button>

    <div id="history">
      <h2>üìã Your History</h2>
      <ul id="sessionList"></ul>
    </div>
  </div>

  <!-- Firebase Modular SDK Scripts -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";

    const firebaseConfig = {
    apiKey: "AIzaSyDIhykRWILcAf_8d1EBaY85ktt7cQrRzMQ",
    authDomain: "yuvrajtimer.firebaseapp.com",
    projectId: "yuvrajtimer",
    storageBucket: "yuvrajtimer.firebasestorage.app",
    messagingSenderId: "680357794474",
    appId: "1:680357794474:web:91e3bcae4d84e7a1fe36d3"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let userId;
    let timerInterval;
    let seconds = 0;

    // üîê Auth Functions
    async function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        userId = userCredential.user.uid;
        document.getElementById("user-email").textContent = userCredential.user.email;
        showApp();
        getHistory();
      } catch (error) {
        alert("Login failed: " + error.message);
      }
    }

    async function register() {
      const email = document.getElementById("reg-email").value;
      const password = document.getElementById("reg-password").value;
      try {
        await createUserWithEmailAndPassword(auth, email, password);
        alert("‚úÖ Registered! You can now log in.");
        showLogin();
      } catch (error) {
        alert("Registration failed: " + error.message);
      }
    }

    function logout() {
      signOut(auth).then(() => {
        location.reload();
      }).catch(error => {
        alert("Logout error: " + error.message);
      });
    }

    // üëÄ UI Toggle Functions
    function showRegister() {
      document.getElementById("login").style.display = "none";
      document.getElementById("register").style.display = "block";
    }

    function showLogin() {
      document.getElementById("register").style.display = "none";
      document.getElementById("login").style.display = "block";
    }

    function showApp() {
      document.getElementById("login").style.display = "none";
      document.getElementById("register").style.display = "none";
      document.getElementById("app").style.display = "block";
    }

    // ‚è±Ô∏è Timer Functions
    function startTimer() {
      if (!timerInterval) {
        timerInterval = setInterval(() => {
          seconds++;
          updateDisplay();
        }, 1000);
      }
    }

    function stopTimer() {
      clearInterval(timerInterval);
      timerInterval = null;
      const duration = formatTime(seconds);
      if (seconds > 0) {
        saveSession(duration);
      }
    }

    function resetTimer() {
      if (!timerInterval) {
        seconds = 0;
        updateDisplay();
      } else {
        alert("‚è∏Ô∏è Stop the timer before resetting.");
      }
    }

    function updateDisplay() {
      document.getElementById("timer").textContent = formatTime(seconds);
    }

    function formatTime(sec) {
      const h = String(Math.floor(sec / 3600)).padStart(2, '0');
      const m = String(Math.floor((sec % 3600) / 60)).padStart(2, '0');
      const s = String(sec % 60).padStart(2, '0');
      return `${h}:${m}:${s}`;
    }

    // üìã Session Save & History
    async function saveSession(duration) {
      await addDoc(collection(db, "users", userId, "sessions"), {
        duration,
        timestamp: new Date().toISOString(),
        device: navigator.userAgent
      });
      seconds = 0;
      updateDisplay();
      getHistory();
    }

    async function getHistory() {
      const sessionRef = collection(db, "users", userId, "sessions");
      const q = query(sessionRef, orderBy("timestamp", "desc"));
      const snapshot = await getDocs(q);
      const list = document.getElementById("sessionList");
      list.innerHTML = "";
      snapshot.forEach(doc => {
        const data = doc.data();
        const li = document.createElement("li");
        li.textContent = `${data.duration} on ${new Date(data.timestamp).toLocaleString()}`;
        list.appendChild(li);
      });
    }

    // üåê Make functions accessible to buttons
    window.login = login;
    window.register = register;
    window.logout = logout;
    window.showRegister = showRegister;
    window.showLogin = showLogin;
    window.startTimer = startTimer;
    window.stopTimer = stopTimer;
    window.resetTimer = resetTimer;
  </script>
</body>
</html>
